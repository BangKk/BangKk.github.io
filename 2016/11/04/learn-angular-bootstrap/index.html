<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>理解Angular启动过程 · BangKk</title><meta name="description" content="理解Angular启动过程 - BangKk"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://bangkk.github.io/atom.xml" title="BangKk"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="https://github.com/BangKk" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">理解Angular启动过程</h1><div class="post-info">2016年11月4日</div><div class="post-content"><h2 id="一张图理解Angular启动流程"><a href="#一张图理解Angular启动流程" class="headerlink" title="一张图理解Angular启动流程"></a>一张图理解Angular启动流程</h2><p><img src="http://og4g35bhc.bkt.clouddn.com/angular-startup.png" alt="Angular启动过程图"><br><a id="more"></a><br>这张图是Angular官网中开发指南的一张图，你可以在<a href="https://code.angularjs.org/1.3.8/docs/guide/bootstrap" target="_blank" rel="external">官方文档</a>上了解它。</p>
<p>接下来我们来一步步的了解它。</p>
<h2 id="一、下载资源"><a href="#一、下载资源" class="headerlink" title="一、下载资源"></a>一、下载资源</h2><p>当你跳转到一个页面时，浏览器首先会去下载这个HTML文件，同时，浏览器还是开启一些辅助线程去</p>
<p>下载相关联的文件（CSS,JS等文件）。</p>
<h2 id="二、构建DOM树"><a href="#二、构建DOM树" class="headerlink" title="二、构建DOM树"></a>二、构建DOM树</h2><p>在下载文件的同时，浏览器就会开始构建DOM树，DOM树中内嵌或引入的脚本也会开始执行。</p>
<h2 id="三、Angular初始化"><a href="#三、Angular初始化" class="headerlink" title="三、Angular初始化"></a>三、Angular初始化</h2><p>浏览器会根据加载脚本的顺序去执行这些脚本。当执行到Angular.js时，Angular会执行如下步骤：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (<span class="built_in">window</span>.angular.bootstrap) &#123;<span class="comment">//检查是不是多次启动/导入angular.js</span></div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'WARNING: Tried to load angular more than once.'</span>);</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">bindJQuery();<span class="comment">//如果在Angular加载之前引入了jQuery则用jQuery，否则用Angular内置的jqlite</span></div><div class="line"></div><div class="line">publishExternalAPI(angular);<span class="comment">//对angular对象绑定ng发布的方法</span></div><div class="line"></div><div class="line">jqLite(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    angularInit(<span class="built_in">document</span>, bootstrap);<span class="comment">//将启动代码挂载到document对象的DOMContentLoaded事件中</span></div><div class="line">  &#125;);</div></pre></td></tr></table></figure>
<p>然后继续执行其他的脚本。</p>
<p><strong>注意：</strong> 在实际项目中，其他的脚本一般指自己Angular代码或者第三方库，这些Angular模块的初始化步骤大概是这样的：</p>
<ul>
<li>按名字创建模块，并在这个模块中注册各种Angular对象，如Controller，Service等，形成注册表；</li>
<li>注册“config回调函数”，它将在模块被初始化时执行；</li>
<li>注册“run回调函数”，它将在模块初始化完毕时执行；</li>
</ul>
<p>当DOM构建完毕时，就会触发document的DOMContentLoaded事件，并执行Angular的启动代码。</p>
<h2 id="四、Angular启动"><a href="#四、Angular启动" class="headerlink" title="四、Angular启动"></a>四、Angular启动</h2><p>Angular首先会去页面中找到第一个带有<code>ng-app</code>的节点，然后调用<code>angular.bootstrap</code>方法，</p>
<p>将该节点作为模块的根节点。刚刚所说的是Angular推荐的自启动方式，当然你也可以采用手动</p>
<p><code>angular.bootstrap</code>方式来启动。</p>
<h2 id="五、加载-启动子模块"><a href="#五、加载-启动子模块" class="headerlink" title="五、加载 / 启动子模块"></a>五、加载 / 启动子模块</h2><p>在这一步之前，DOM还没有和模型之间建立关联，所以它还是<code>Static DOM</code>。</p>
<p>而在这个阶段中，Angular会做以下几件事：</p>
<ol>
<li>创建一个注入器（injector），并关联到所在的节点上（带有<code>ng-app</code>的节点）。</li>
<li>按顺序执行所有的“config回调函数”</li>
<li>执行所有“run回调函数”</li>
</ol>
<p><strong>注意：</strong> 前面注册的Angular对象只有通过注入器注入到模块中才能使用。在config回调函数中能够使用的</p>
<p>只有注册的常量<code>Constant</code>对象和<code>Provider</code>类，这个阶段是程序中唯一能通过<code>Provider</code>类来配置服务</p>
<p>的地方。我们对<code>$routeProvider</code>的配置就是在这个阶段完成的。</p>
<h2 id="六、渲染页面"><a href="#六、渲染页面" class="headerlink" title="六、渲染页面"></a>六、渲染页面</h2><p>接下来，将由路由模块获得控制权。通过<code>$location</code>服务来解析当前页面的URL，然后通过我们之前配</p>
<p>置的路由映射表找到对应的模板，控制器。</p>
<p>路由模块首先会创建一个scope对象，加载模板并将它传给<code>$compile</code>对象，<code>$compile</code>会将它解析成静</p>
<p>态DOM树，然后扫描这颗树，找到节点中的指令，通过这些指令把DOM树和scope关联起来，最后将它</p>
<p>替换一个特定的指令，在<code>ui-router</code>中是<code>ui-view</code>。</p>
<h2 id="七、数据绑定和摘要循环（digest）"><a href="#七、数据绑定和摘要循环（digest）" class="headerlink" title="七、数据绑定和摘要循环（digest）"></a>七、数据绑定和摘要循环（digest）</h2><p>页面显示出来后，数据还没有渲染，Angular会自动使用scope中的数据渲染一次。</p>
<p>但是，如果用户修改了这些数据怎么办？在Angular中会采用脏检查机制。Angular将双向绑定转换为一</p>
<p>堆watch表达式后台递归检查这些watch表达式是否改变了，如果改变了，就执行相应的watcher函数，</p>
<p>直到model中的值不在变化，watcher函数不再触发。这时，浏览器就会重新渲染DOM。</p>
<p>至此，一个Angular程序就算启动成功了。</p>
<p>最近读完了<a href="https://book.douban.com/subject/26708133/" target="_blank" rel="external">AngularJS深度剖析与最佳实践</a>，是目前学习Angular1.X最有价值的一本书，如果你有一定</p>
<p>的Angular实践或者经验，这本书可以让你更深入了解Angular背后的原理和技巧。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li>[1] <a href="https://book.douban.com/subject/26708133/" target="_blank" rel="external">AngularJS深度剖析与最佳实践</a></li>
</ul>
</div></article></div></section><footer><div class="paginator"><a href="/2016/10/29/about-me/" class="next">NEXT</a></div><div data-thread-key="2016/11/04/learn-angular-bootstrap/" data-title="理解Angular启动过程" data-url="https://bangkk.github.io/2016/11/04/learn-angular-bootstrap/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"BangKk"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2016 <a href="https://bangkk.github.io">BangKk</a>: 天气转凉，请多穿条秋裤 :)</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>